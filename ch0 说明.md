

#### rpc 包含什么内容？

rpc 最原始的诉求其实就是：像调用本地服务一样，调用远程的服务。我们在进行 rpc 调用时，也确实有一种在调用本地服务的感觉。

这个流程听起来很神奇，实际上也不难猜出其实现流程：本地服务 C 在收到调用请求时，只需要将该请求参数，通过网络发送给对应的远端真实的服务 P；而 P 收到请求参数后，会进行真正的本地处理；随后 P 再把处理的结果，再通过网络返回给 C。而 C 收到其返回结果后，再将返回结果返还给调用处即可。

我们可以看到，C 和 P 是 rpc 流程中真正的参与者，C 只需要知道 P 的网络地址，即可发起 rpc 调用。这个时候就产生了许多新的问题：

```bash
1 C 想要调用 P，是不是得写死 P 的地址？
2 如果 P 存在多个节点，C 是不是全部都得去保存？
3 如果 P 某个节点的地址发生下线，C 怎么去感知？
```

由此，rpc 引入了第三个参与者，这便是注册中心。有了注册中心之后，注册中心会告知 C，每一个可用的 P 的地址是什么？当 P 中有新成员加入，或者有老成员下线，C 都可以从注册中心上获取到。这样，一个完整 rpc 模型包含的内容便呼之欲出了。





#### rpc 框架做了什么？

我们知道，发起 rpc 调用，最终调用的还是本地的一个对象。只是这个对象会偷偷将请求发送给真正的服务提供者，然后从那边获取到返回结果后，再将结果进行代理返回。所以一般情况下，rpc 就会通过代理模式，往项目中用到 rpc 服务远程调用的地方，注入一个**代理 bean**，由这个代理 bean 完成服务的远程调用。只不过这样代理 bean 是一个非常强大的存在，我们看到的只是冰山一角，其下有着非常庞大、复杂的运作机制。一个基本的 rpc 框架至少要做以下这些事情：

- 对于服务暴露：
  - 主动发现项目中业务代码进行了服务暴露
  - 收集待暴露的服务对象的信息，组装 rpc 服务端并监听端口
  - 把本机信息暴露到注册中心上
  - 能够接收来自客户端的服务请求
  - 能够根据客户端的请求，执行对应的方法，并将响应返回出去
- 对于服务引用：
  - 主动发现项目中业务代码进行了服务引用
  - 根据服务引用信息，生成 rpc 客户端（代理 bean）
  - 从注册中心上获取引用服务的信息
  - 能够根据服务引用信息，将请求发到指定地点
  - 能够接收服务端的执行结果，并返回给业务侧





#### sofa rpc 源码说明

比较出乎人意料的是，sofa rpc 的职责更多关注的还是 rpc 层面。很多内容并不是 sofa rpc 做的，而是 sofastack 生态下其他产品做的。我们把 sofa rpc 跑起来，实现 rpc 通信，是 sofa 各个产品协作的结果，看源码时应该分清楚各个产品的职责：

- 网络通信：sofa-bolt 做的，其基于 netty 实现，专注于网络通信
- 编程界面：sofa-boot 做的，sofa-boot 是 sofastack 推出的开发框架，主要用来聚合 sofa 的各个产品
- 注册中心使用：sofa-registry-client 做的，这是 sofa 注册中心团队推出的 java 客户端







#### 观前提示

在这个系列文章中，主要是按照几个问题来整理的主线：

- rpc 框架是怎么发现你项目中写了服务引用 or 服务暴露？
- rpc 框架是怎么实现引用服务 or 暴露服务的？
- 一次 rpc 通信会经历那些流程？
- 一些细节是怎么实现的？

其实文章关注的不仅仅是 sofa rpc 做了什么。牵涉到的 sofaboot、sofabolt、sofa-registry-client 也会做相应解读。阅读前还是希望您拥有一定的 rpc 使用经验，对与 spring 源码有一定的阅读和了解，对并发、netty 有自己的知识积累。

需要注意的是，文中展示的源码全部进行了删减，只留下了重要部分供参考，建议观看时自行 git clone 相关源代码。

> 其实 sofa 的源码，本人更多关注的是**主线行为** + **一些的重要细节行为**。很多时候，都是业务系统的同事来咨询问题时，我才会深入看一些内容，以便解决他们的问题。当然，在平时积累知识时，遇到一些问题和想不明白的地方，也会来学习一下，看看这些大厂工程师，是怎么解决问题的，更多的是学习他们的方案和思路。
>
> 本人在阅读源码时，很多细节很难在社区找到对应的设计文档，基本上所有内容都是纯闭门硬啃出来的，因此很难避免文中会有不准确的地方，欢迎大家指正。
>
> 该源码梳理更多是平日的笔记整理得出，更多是方便自己查阅和研究。如果给您带来一定帮助，那这些笔记也算是有了更高层次的价值，谢谢您的观看~







#### 声明

文中已经删除了企业版相关的源码内容，只保留开源中的内容，因为我也不知道哪些能说哪些不能说:laughing:



